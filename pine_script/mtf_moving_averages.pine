// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © TradingView Indicators Collection

//@version=5
indicator("Multi-Timeframe Moving Averages", shorttitle="MTF MAs", overlay=true)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// MA Type Selection
maType = input.string("EMA", "MA Type", options=["SMA", "EMA", "WMA", "VWMA", "HMA", "TEMA", "DEMA"])

// Fast MA Settings
showFastMA = input.bool(true, "Show Fast MA", group="Fast MA")
fastLength = input.int(9, "Fast Length", minval=1, group="Fast MA")
fastTimeframe = input.timeframe("", "Fast Timeframe", group="Fast MA")
fastColor = input.color(color.new(color.green, 0), "Fast Color", group="Fast MA")

// Medium MA Settings
showMediumMA = input.bool(true, "Show Medium MA", group="Medium MA")
mediumLength = input.int(21, "Medium Length", minval=1, group="Medium MA")
mediumTimeframe = input.timeframe("", "Medium Timeframe", group="Medium MA")
mediumColor = input.color(color.new(color.blue, 0), "Medium Color", group="Medium MA")

// Slow MA Settings
showSlowMA = input.bool(true, "Show Slow MA", group="Slow MA")
slowLength = input.int(50, "Slow Length", minval=1, group="Slow MA")
slowTimeframe = input.timeframe("", "Slow Timeframe", group="Slow MA")
slowColor = input.color(color.new(color.red, 0), "Slow Color", group="Slow MA")

// Extra Slow MA Settings (200 MA)
showExtraSlowMA = input.bool(true, "Show 200 MA", group="Extra Slow MA")
extraSlowLength = input.int(200, "Extra Slow Length", minval=1, group="Extra Slow MA")
extraSlowTimeframe = input.timeframe("", "Extra Slow Timeframe", group="Extra Slow MA")
extraSlowColor = input.color(color.new(color.purple, 0), "Extra Slow Color", group="Extra Slow MA")

// Visual Settings
showCrossovers = input.bool(true, "Show Crossover Signals", group="Visual")
showCloud = input.bool(false, "Show MA Cloud", group="Visual")
cloudOpacity = input.int(85, "Cloud Opacity", minval=0, maxval=100, group="Visual")

// ══════════════════════════════════════════════════════════════════════════════
// MA CALCULATION FUNCTIONS
// ══════════════════════════════════════════════════════════════════════════════

// Hull Moving Average
hma(src, len) =>
    wma1 = ta.wma(src, len / 2)
    wma2 = ta.wma(src, len)
    ta.wma(2 * wma1 - wma2, math.round(math.sqrt(len)))

// Triple Exponential Moving Average
tema(src, len) =>
    ema1 = ta.ema(src, len)
    ema2 = ta.ema(ema1, len)
    ema3 = ta.ema(ema2, len)
    3 * (ema1 - ema2) + ema3

// Double Exponential Moving Average
dema(src, len) =>
    ema1 = ta.ema(src, len)
    ema2 = ta.ema(ema1, len)
    2 * ema1 - ema2

// Universal MA Function
calculateMA(src, len, type) =>
    switch type
        "SMA" => ta.sma(src, len)
        "EMA" => ta.ema(src, len)
        "WMA" => ta.wma(src, len)
        "VWMA" => ta.vwma(src, len)
        "HMA" => hma(src, len)
        "TEMA" => tema(src, len)
        "DEMA" => dema(src, len)
        => ta.ema(src, len)

// ══════════════════════════════════════════════════════════════════════════════
// MULTI-TIMEFRAME MA CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// Calculate MAs on their respective timeframes
fastMA = request.security(syminfo.tickerid, fastTimeframe, calculateMA(close, fastLength, maType), barmerge.gaps_off, barmerge.lookahead_off)
mediumMA = request.security(syminfo.tickerid, mediumTimeframe, calculateMA(close, mediumLength, maType), barmerge.gaps_off, barmerge.lookahead_off)
slowMA = request.security(syminfo.tickerid, slowTimeframe, calculateMA(close, slowLength, maType), barmerge.gaps_off, barmerge.lookahead_off)
extraSlowMA = request.security(syminfo.tickerid, extraSlowTimeframe, calculateMA(close, extraSlowLength, maType), barmerge.gaps_off, barmerge.lookahead_off)

// ══════════════════════════════════════════════════════════════════════════════
// CROSSOVER DETECTION
// ══════════════════════════════════════════════════════════════════════════════

// Fast/Medium crossovers
bullishCross = ta.crossover(fastMA, mediumMA)
bearishCross = ta.crossunder(fastMA, mediumMA)

// Golden/Death Cross (50/200)
goldenCross = ta.crossover(slowMA, extraSlowMA)
deathCross = ta.crossunder(slowMA, extraSlowMA)

// ══════════════════════════════════════════════════════════════════════════════
// TREND DETECTION
// ══════════════════════════════════════════════════════════════════════════════

// Determine overall trend
bullishTrend = fastMA > mediumMA and mediumMA > slowMA
bearishTrend = fastMA < mediumMA and mediumMA < slowMA

// Price position relative to MAs
priceAboveAllMAs = close > fastMA and close > mediumMA and close > slowMA and close > extraSlowMA
priceBelowAllMAs = close < fastMA and close < mediumMA and close < slowMA and close < extraSlowMA

// ══════════════════════════════════════════════════════════════════════════════
// PLOTTING
// ══════════════════════════════════════════════════════════════════════════════

// Plot Moving Averages
plot(showFastMA ? fastMA : na, "Fast MA", color=fastColor, linewidth=2)
plot(showMediumMA ? mediumMA : na, "Medium MA", color=mediumColor, linewidth=2)
plot(showSlowMA ? slowMA : na, "Slow MA", color=slowColor, linewidth=2)
plot(showExtraSlowMA ? extraSlowMA : na, "Extra Slow MA", color=extraSlowColor, linewidth=3)

// Plot MA Cloud between fast and slow
cloudColor = fastMA > slowMA ? color.new(color.green, cloudOpacity) : color.new(color.red, cloudOpacity)
p1 = plot(showCloud ? fastMA : na, display=display.none)
p2 = plot(showCloud ? slowMA : na, display=display.none)
fill(p1, p2, color=showCloud ? cloudColor : na, title="MA Cloud")

// Plot Crossover Signals
plotshape(showCrossovers and bullishCross, "Bullish Cross", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(showCrossovers and bearishCross, "Bearish Cross", shape.triangledown, location.abovebar, color.red, size=size.small)

// Golden/Death Cross signals
plotshape(showCrossovers and goldenCross, "Golden Cross", shape.diamond, location.belowbar, color.new(color.yellow, 0), size=size.normal, text="Golden")
plotshape(showCrossovers and deathCross, "Death Cross", shape.diamond, location.abovebar, color.new(color.fuchsia, 0), size=size.normal, text="Death")

// Background color for strong trends
bgcolor(bullishTrend and priceAboveAllMAs ? color.new(color.green, 95) : na, title="Strong Bullish")
bgcolor(bearishTrend and priceBelowAllMAs ? color.new(color.red, 95) : na, title="Strong Bearish")

// ══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ══════════════════════════════════════════════════════════════════════════════

alertcondition(bullishCross, "Bullish Crossover", "Fast MA crossed above Medium MA")
alertcondition(bearishCross, "Bearish Crossover", "Fast MA crossed below Medium MA")
alertcondition(goldenCross, "Golden Cross", "50 MA crossed above 200 MA")
alertcondition(deathCross, "Death Cross", "50 MA crossed below 200 MA")
alertcondition(priceAboveAllMAs, "Price Above All MAs", "Price is above all moving averages")
alertcondition(priceBelowAllMAs, "Price Below All MAs", "Price is below all moving averages")

// ══════════════════════════════════════════════════════════════════════════════
// INFO TABLE
// ══════════════════════════════════════════════════════════════════════════════

showTable = input.bool(true, "Show Info Table", group="Visual")
tablePosition = input.string("top_right", "Table Position", options=["top_right", "top_left", "bottom_right", "bottom_left"], group="Visual")

var table infoTable = table.new(tablePosition == "top_right" ? position.top_right : tablePosition == "top_left" ? position.top_left : tablePosition == "bottom_right" ? position.bottom_right : position.bottom_left, 3, 6, bgcolor=color.new(color.black, 80), border_width=1)

if showTable and barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "MA", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Value", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 2, 0, "vs Price", text_color=color.white, text_size=size.small)
    
    // Fast MA
    table.cell(infoTable, 0, 1, "Fast (" + str.tostring(fastLength) + ")", text_color=fastColor, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(fastMA, "#.##"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 2, 1, close > fastMA ? "▲" : "▼", text_color=close > fastMA ? color.green : color.red, text_size=size.small)
    
    // Medium MA
    table.cell(infoTable, 0, 2, "Medium (" + str.tostring(mediumLength) + ")", text_color=mediumColor, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(mediumMA, "#.##"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 2, 2, close > mediumMA ? "▲" : "▼", text_color=close > mediumMA ? color.green : color.red, text_size=size.small)
    
    // Slow MA
    table.cell(infoTable, 0, 3, "Slow (" + str.tostring(slowLength) + ")", text_color=slowColor, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(slowMA, "#.##"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 2, 3, close > slowMA ? "▲" : "▼", text_color=close > slowMA ? color.green : color.red, text_size=size.small)
    
    // Extra Slow MA
    table.cell(infoTable, 0, 4, "ExtraSlow (" + str.tostring(extraSlowLength) + ")", text_color=extraSlowColor, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(extraSlowMA, "#.##"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 2, 4, close > extraSlowMA ? "▲" : "▼", text_color=close > extraSlowMA ? color.green : color.red, text_size=size.small)
    
    // Trend
    trendText = bullishTrend ? "BULLISH" : bearishTrend ? "BEARISH" : "NEUTRAL"
    trendColor = bullishTrend ? color.green : bearishTrend ? color.red : color.gray
    table.cell(infoTable, 0, 5, "Trend:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, trendText, text_color=trendColor, text_size=size.small)
    table.cell(infoTable, 2, 5, "", text_color=color.white, text_size=size.small)
