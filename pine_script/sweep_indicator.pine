// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
//@version=5
indicator("Sweep Indicator", shorttitle="Sweep", overlay=true, max_labels_count=500, max_boxes_count=500)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

atrLength = input.int(5, "ATR Length", minval=1)
smaLength = input.int(35, "SMA Length", minval=1)
minAtrMult = input.float(0.5, "Min ATR Multiplier", minval=0.1, step=0.1)
maxAtrMult = input.float(2.0, "Max ATR Multiplier", minval=0.5, step=0.1)
closeThreshold = input.float(0.6, "Close Position Threshold", minval=0.0, maxval=1.0, step=0.05)

// Colors
bullishColor = input.color(color.green, "Bullish Color")
bearishColor = input.color(color.red, "Bearish Color")
boxOpacity = input.int(80, "Box Opacity", minval=0, maxval=100)

// ══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

atr5 = ta.atr(atrLength)
sma35 = ta.sma(close, smaLength)

candleRange = high - low
closePosition = candleRange > 0 ? (close - low) / candleRange : 0.5

bullishPercent = closePosition * 100
bearishPercent = (1 - closePosition) * 100

validSize = candleRange >= (minAtrMult * atr5) and candleRange <= (maxAtrMult * atr5)

// ══════════════════════════════════════════════════════════════════════════════
// SETUPS
// ══════════════════════════════════════════════════════════════════════════════

sweepsLow = low < low[1]
bullishClose = closePosition >= closeThreshold
aboveSMA = close > sma35
bullishSetup = sweepsLow and validSize and bullishClose and aboveSMA

sweepsHigh = high > high[1]
bearishClose = closePosition <= (1 - closeThreshold)
belowSMA = close < sma35
bearishSetup = sweepsHigh and validSize and bearishClose and belowSMA

// ══════════════════════════════════════════════════════════════════════════════
// VISUAL MARKERS - BULLISH
// ══════════════════════════════════════════════════════════════════════════════

var box bullBox = na
var label bullPctLabel = na

if bullishSetup
    bullBoxTop = low
    bullBoxBot = low - atr5
    bullBgColor = color.new(bullishColor, boxOpacity)
    atrText = str.tostring(atr5, "#.##")
    pctText = str.tostring(bullishPercent, "#") + "%"
    
    bullBox := box.new(bar_index, bullBoxTop, bar_index + 1, bullBoxBot, bullishColor, 1, line.style_solid, extend.none, xloc.bar_index, bullBgColor, atrText, size.small, bullishColor)
    bullPctLabel := label.new(bar_index, high, pctText, xloc.bar_index, yloc.price, bullishColor, label.style_label_down, color.white, size.small)

// ══════════════════════════════════════════════════════════════════════════════
// VISUAL MARKERS - BEARISH
// ══════════════════════════════════════════════════════════════════════════════

var box bearBox = na
var label bearPctLabel = na

if bearishSetup
    bearBoxTop = high + atr5
    bearBoxBot = high
    bearBgColor = color.new(bearishColor, boxOpacity)
    atrText = str.tostring(atr5, "#.##")
    pctText = str.tostring(bearishPercent, "#") + "%"
    
    bearBox := box.new(bar_index, bearBoxTop, bar_index + 1, bearBoxBot, bearishColor, 1, line.style_solid, extend.none, xloc.bar_index, bearBgColor, atrText, size.small, bearishColor)
    bearPctLabel := label.new(bar_index, low, pctText, xloc.bar_index, yloc.price, bearishColor, label.style_label_up, color.white, size.small)

// ══════════════════════════════════════════════════════════════════════════════
// PLOT SMA
// ══════════════════════════════════════════════════════════════════════════════

plot(sma35, "35 SMA", color=color.orange, linewidth=2)

// ══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ══════════════════════════════════════════════════════════════════════════════

alertcondition(bullishSetup, "Bullish Sweep", "Bullish low sweep detected")
alertcondition(bearishSetup, "Bearish Sweep", "Bearish high sweep detected")
