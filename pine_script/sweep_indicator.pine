// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
//@version=5
indicator("Sweep Indicator", shorttitle="Sweep", overlay=true, max_labels_count=500, max_boxes_count=500)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

atrLength = input.int(5, "ATR Length", minval=1)
smaLength = input.int(35, "SMA Length", minval=1)
minAtrMult = input.float(0.5, "Min ATR Multiplier", minval=0.1, step=0.1)
maxAtrMult = input.float(2.0, "Max ATR Multiplier", minval=0.5, step=0.1)
closeThreshold = input.float(0.6, "Close Position Threshold", minval=0.0, maxval=1.0, step=0.05, tooltip="For bullish: close must be >= this % of candle range. For bearish: close must be <= (1 - this %) of range")

// Colors
bullishColor = input.color(color.green, "Bullish Color")
bearishColor = input.color(color.red, "Bearish Color")
boxOpacity = input.int(80, "Box Opacity", minval=0, maxval=100)

// ══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// ATR and SMA
atr5 = ta.atr(atrLength)
sma35 = ta.sma(close, smaLength)

// Candle measurements
candleRange = high - low
closePosition = candleRange > 0 ? (close - low) / candleRange : 0.5

// Percentages
bullishPercent = closePosition * 100           // From bottom (0% = low, 100% = high)
bearishPercent = (1 - closePosition) * 100     // From top (0% = high, 100% = low)

// Size conditions
validSize = candleRange >= (minAtrMult * atr5) and candleRange <= (maxAtrMult * atr5)

// ══════════════════════════════════════════════════════════════════════════════
// BULLISH SETUP (Low Sweep)
// ══════════════════════════════════════════════════════════════════════════════

sweepsLow = low < low[1]
bullishClose = closePosition >= closeThreshold
aboveSMA = close > sma35

bullishSetup = sweepsLow and validSize and bullishClose and aboveSMA

// ══════════════════════════════════════════════════════════════════════════════
// BEARISH SETUP (High Sweep)
// ══════════════════════════════════════════════════════════════════════════════

sweepsHigh = high > high[1]
bearishClose = closePosition <= (1 - closeThreshold)
belowSMA = close < sma35

bearishSetup = sweepsHigh and validSize and bearishClose and belowSMA

// ══════════════════════════════════════════════════════════════════════════════
// VISUAL MARKERS
// ══════════════════════════════════════════════════════════════════════════════

// Bullish: box from low extending downward, percentage at top
if bullishSetup
    // Background box from low down to low - ATR
    box.new(bar_index, low, bar_index, low - atr5, 
            bgcolor=color.new(bullishColor, boxOpacity), 
            border_color=bullishColor,
            border_width=1)
    
    // ATR value label inside the box
    label.new(bar_index, low - (atr5 / 2), str.tostring(atr5, "#.##"), 
              color=color.new(color.white, 100), 
              style=label.style_label_center, 
              textcolor=bullishColor, 
              size=size.small)
    
    // Percentage at top of candle
    label.new(bar_index, high, str.tostring(bullishPercent, "#") + "%", 
              color=bullishColor, 
              style=label.style_label_down, 
              textcolor=color.white, 
              size=size.small)

// Bearish: box from high extending upward, percentage at bottom
if bearishSetup
    // Background box from high up to high + ATR
    box.new(bar_index, high + atr5, bar_index, high, 
            bgcolor=color.new(bearishColor, boxOpacity), 
            border_color=bearishColor,
            border_width=1)
    
    // ATR value label inside the box
    label.new(bar_index, high + (atr5 / 2), str.tostring(atr5, "#.##"), 
              color=color.new(color.white, 100), 
              style=label.style_label_center, 
              textcolor=bearishColor, 
              size=size.small)
    
    // Percentage at bottom of candle (inverted)
    label.new(bar_index, low, str.tostring(bearishPercent, "#") + "%", 
              color=bearishColor, 
              style=label.style_label_up, 
              textcolor=color.white, 
              size=size.small)

// ══════════════════════════════════════════════════════════════════════════════
// PLOT SMA FOR REFERENCE
// ══════════════════════════════════════════════════════════════════════════════

plot(sma35, "35 SMA", color=color.orange, linewidth=2)

// ══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ══════════════════════════════════════════════════════════════════════════════

alertcondition(bullishSetup, "Bullish Sweep", "Bullish low sweep detected")
alertcondition(bearishSetup, "Bearish Sweep", "Bearish high sweep detected")
