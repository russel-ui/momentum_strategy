// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
//@version=5
indicator("Sweep Indicator", shorttitle="Sweep", overlay=true, max_labels_count=500)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

atrLength = input.int(5, "ATR Length", minval=1)
smaLength = input.int(35, "SMA Length", minval=1)
minAtrMult = input.float(0.5, "Min ATR Multiplier", minval=0.1, step=0.1)
maxAtrMult = input.float(2.0, "Max ATR Multiplier", minval=0.5, step=0.1)
closeThreshold = input.float(0.6, "Close Position Threshold", minval=0.0, maxval=1.0, step=0.05, tooltip="For bullish: close must be >= this % of candle range. For bearish: close must be <= (1 - this %) of range")

// Colors
bullishColor = input.color(color.green, "Bullish Color")
bearishColor = input.color(color.red, "Bearish Color")

// ══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// ATR and SMA
atr5 = ta.atr(atrLength)
sma35 = ta.sma(close, smaLength)

// Candle measurements
candleRange = high - low
closePosition = candleRange > 0 ? (close - low) / candleRange : 0.5
closePercent = closePosition * 100

// Size conditions
validSize = candleRange >= (minAtrMult * atr5) and candleRange <= (maxAtrMult * atr5)

// ══════════════════════════════════════════════════════════════════════════════
// BULLISH SETUP (Low Sweep)
// ══════════════════════════════════════════════════════════════════════════════

sweepsLow = low < low[1]
bullishClose = closePosition >= closeThreshold
aboveSMA = close > sma35

bullishSetup = sweepsLow and validSize and bullishClose and aboveSMA

// ══════════════════════════════════════════════════════════════════════════════
// BEARISH SETUP (High Sweep)
// ══════════════════════════════════════════════════════════════════════════════

sweepsHigh = high > high[1]
bearishClose = closePosition <= (1 - closeThreshold)
belowSMA = close < sma35

bearishSetup = sweepsHigh and validSize and bearishClose and belowSMA

// ══════════════════════════════════════════════════════════════════════════════
// VISUAL MARKERS
// ══════════════════════════════════════════════════════════════════════════════

// Bullish: marker below candle, percentage label above candle
if bullishSetup
    // Arrow/marker below the low pointing to the sweep area
    label.new(bar_index, low - atr5, "▲\n|\n|\n|", 
              color=color.new(bullishColor, 70), 
              style=label.style_none, 
              textcolor=bullishColor, 
              size=size.large,
              textalign=text.align_center)
    
    // Percentage at top of candle
    label.new(bar_index, high, str.tostring(closePercent, "#") + "%", 
              color=bullishColor, 
              style=label.style_label_down, 
              textcolor=color.white, 
              size=size.small)

// Bearish: marker above candle, percentage label below candle
if bearishSetup
    // Arrow/marker above the high pointing to the sweep area
    label.new(bar_index, high + atr5, "|\n|\n|\n▼", 
              color=color.new(bearishColor, 70), 
              style=label.style_none, 
              textcolor=bearishColor, 
              size=size.large,
              textalign=text.align_center)
    
    // Percentage at bottom of candle
    label.new(bar_index, low, str.tostring(closePercent, "#") + "%", 
              color=bearishColor, 
              style=label.style_label_up, 
              textcolor=color.white, 
              size=size.small)

// ══════════════════════════════════════════════════════════════════════════════
// PLOT SMA FOR REFERENCE
// ══════════════════════════════════════════════════════════════════════════════

plot(sma35, "35 SMA", color=color.orange, linewidth=2)

// ══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ══════════════════════════════════════════════════════════════════════════════

alertcondition(bullishSetup, "Bullish Sweep", "Bullish low sweep detected")
alertcondition(bearishSetup, "Bearish Sweep", "Bearish high sweep detected")
